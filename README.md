
# ECPA_Emotional_Video_Captioning
Human-centric Emotional Video Captioning (H-EVC) aims to generate fine-grained, emotion-related sentences for human-based videos, enhancing human emotions and facilitating human-computer emotional interaction.

# Requirements
We use [Docker image of SwinBert](https://hub.docker.com/r/linjieli222/videocap_torch1.7/tags) for easier reproduction. Please install the following:
Nvidia driver (418+),
Docker (19.03+),
nvidia-container-toolkit.
We only support Linux with NVIDIA GPUs. We test on Ubuntu 18.04 and RTX 3090 Ti card. 
# Download
## Create folders that store pretrained models, datasets, and predictions.
<div style="background-color: #f6f8fa; padding: 10px; border-radius: 5px;">

```bash
export REPO_DIR=$PWD
mkdir -p $REPO_DIR/models  # pre-trained models
mkdir -p $REPO_DIR/datasets  # datasets
mkdir -p $REPO_DIR/predictions  # prediction outputs
```
## Pretrained models.

Our pre-trained models can be downloaded with the following command.
<div style="background-color: #f6f8fa; padding: 10px; border-radius: 5px;">

```bash
cd $REPO_DIR
bash scripts/download_models.sh
```
The script will download our models that are trained for VATEX, MSRVTT, MSVD, TVC and YouCook2, respectively. It will also download our training logs and output predictions.
## Pretrained Video Swin Transformers.
To run our code smoothly, please visit [Video Swin Transformer](https://github.com/SwinTransformer/Video-Swin-Transformer) to download pre-trained weights models.
Download swin_base_patch244_window877_kinetics*_22k.pth, and place them under ${REPO_DIR}/models/video_swin_transformer directory.
# Quick Demo
We provide a demo to run end-to-end inference on the test video. Our inference code will take a human-based video as input and generate an emotional video caption. [MAFW](https://example.com/data.zip) | [EmoVidCap](https://example.com/checkpoint.zip)| [best-checkpoint](https://pan.baidu.com/s/1wxl6aSXOaOqv_4GbELWRlQ?pwd=sqdg)

# Evaluation 
<div style="background-color: #f6f8fa; padding: 10px; border-radius: 5px;">

```bash
EVAL_DIR='./models/table1/MAFW/best-checkpoint/'
CHECKPOINT='./models/table1/MAFW/best-checkpoint/model.bin'
VIDEO='./docs/G0mjFqytJt4_000152_000162.mp4'
CUDA_VISIBLE_DEVICES=0 python src/tasks/ECPA_inference.py \
       --resume_checkpoint $CHECKPOINT  \
       --eval_model_dir $EVAL_DIR \
       --test_video_fname $VIDEO \
       --do_lower_case \
       --do_test 
```    

## Evaluation results
Performances w/o our ECPA under different captioning frameworks with various vision-language models. The best results are in bold, and the second is underlined.

![Example Image](samples/table5.png)

## ⭐ Demos
### 1. Captions generated by SWINBERT and ECPA on the (a-c) MAFW and (d) EmVidCap datasets, respectively. Green fonts indicate correctly generated AU-related words, red indicates incorrectly generated words, and blue fonts represent words with semantics similar to the ground truth.
<table>
  <tr>
    <td style="text-align: center; padding: 10px; display: flex; flex-direction: column; align-items: center;">
      <img src="samples/02358.gif" alt="演示动画1" style="width: 300px; height: 200px; border-radius: 8px;">
      <div style="background-color: #f6f8fa; padding: 10px; border-radius: 8px; margin-top: 10px; width: 300px; min-height: 220px; display: flex; flex-direction: column; justify-content: center;">
        <p style="word-wrap: break-word; margin: 0; text-align: center;">GT: A woman crosses her arms and talks to the other person, then takes away theplate that places on the couch. The frown and the wrinkled nose. <br>SwinBERT: a woman is not by the man in front of her, the marked frown and the open mouth. <br>ECPA: a woman speaks to the person in front of her. the frown and the wrinklec
nose.</p>
      </div>
    </td>
    <td style="text-align: center; padding: 10px; display: flex; flex-direction: column; align-items: center;">
      <img src="samples/00721.gif" alt="演示动画2" style="width: 300px; height: 200px; border-radius: 8px;">
      <div style="background-color: #f6f8fa; padding: 10px; border-radius: 8px; margin-top: 10px; width: 300px; min-height: 220px; display: flex; flex-direction: column; justify-content: center;">
        <p style="word-wrap: break-word; margin: 0; text-align: center;">GT: A man turns his head to look at someone, chews something, and sighs. The frown and the slight open mouth. <br>SwinBERT: a man sighs. the frown and the closed eyes. <br>ECPA: a man looks at the other and sighs. the frown and the slightly open mouth.</p>
      </div>
    </td>
  </tr>
</table>
<table>
  <tr>
    <td style="text-align: center; padding: 10px; display: flex; flex-direction: column; align-items: center;">
      <img src="samples/02581.gif" alt="演示动画3" style="width: 300px; height: 200px; border-radius: 8px;">
      <div style="background-color: #f6f8fa; padding: 10px; border-radius: 8px; margin-top: 10px; width: 300px; min-height: 220px; display: flex; flex-direction: column; justify-content: center;">
        <p style="word-wrap: break-word; margin: 0; text-align: center;">GT: A man talks to the other side of his head. The frown, the wrinkled nose and the slightly open mouth. <br>SwinBERT: a man looks at the other in front of him. the frown and the wide eyes. <br> ECPA:a man looks at the other side of his head. the frown and the slightly compressed lips.</p>
      </div>
    </td>
    <td style="text-align: center; padding: 10px; display: flex; flex-direction: column; align-items: center;">
      <img src="samples/70812.gif" alt="演示动画4" style="width: 300px; height: 200px; border-radius: 8px;">
      <div style="background-color: #f6f8fa; padding: 10px; border-radius: 8px; margin-top: 10px; width: 300px; min-height: 220px; display: flex; flex-direction: column; justify-content: center;">
        <p style="word-wrap: break-word; margin: 0; text-align: center;">GT: A man was reading a script while another man was putting small animals on him to astonish him. <br>SwinBERT: the man was reading a script while another man was reading a script. <br>ECPA: to the surprise, the man was reading a script while another man was putting small animals on him.</p>
      </div>
    </td>
  </tr>
</table>



### 2. Captions generated by baseline （Video Swin Transformers）and with different prompt levels, respectively. Green fonts indicate correctly generated fine-gained emotion words, and red indicates error words.
<table>
  <tr>
    <td style="text-align: center; padding: 10px; display: flex; flex-direction: column; align-items: center;">
      <img src="samples/02253.gif" alt="演示动画1" style="width: 300px; height: 200px; border-radius: 8px;">
      <div style="background-color: #f6f8fa; padding: 10px; border-radius: 8px; margin-top: 10px; width: 300px; min-height: 220px; display: flex; flex-direction: column; justify-content: center;">
        <p style="word-wrap: break-word; margin: 0; text-align: center;">GT: A man looks at his laptop and speaks.The frown, the wrinkled nose and the slightly open mouth. <br>Baseline: a man smiles and <p style="color:red">speaks</p> to the camera. the raised lip corners. <br>Baseline + ER-level prompts: a man looks at the man in front of him. the wide eyes and the slightly open mouth. <br> Baseline + ER- and AY-level prompts: a man sits in the chair and talks to the other. the marked frown and the wrinkled nose.</p>
      </div>
    </td>
    <td style="text-align: center; padding: 10px; display: flex; flex-direction: column; align-items: center;">
      <img src="samples/01158.gif" alt="演示动画3" style="width: 300px; height: 200px; border-radius: 8px;">
      <div style="background-color: #f6f8fa; padding: 10px; border-radius: 8px; margin-top: 10px; width: 300px; min-height: 220px; display: flex; flex-direction: column; justify-content: center;">
        <p style="word-wrap: break-word; margin: 0; text-align: center;">GT: A man speaks to the camera. The open mouth and the wide eyes. <br>Baseline : a man smiles and speaks to the camera. the raised lip corners. <br>Baseline + ER-level prompts: a man speaks to the man in front of him. the wide eyes and the slightly open mouth. <br>Baseline + ER- and AU-level prompts: a man speaks excitedly. the wide eyes and the open mouth.</p>
      </div>
    </td>
  </tr>
</table>




